ssp = "SSP2",
year_list = c(2010:2099))
SSP3 = get_dscim_econ_vars(units = "gdppc",
regions = "global",
iam = "low",
ssp = "SSP3",
year_list = c(2010:2099))
SSP4 = get_dscim_econ_vars(units = "gdppc",
regions = "global",
iam = "low",
ssp = "SSP4",
year_list = c(2010:2099))
SSP5 = get_dscim_econ_vars(units = "gdppc",
regions = "global",
iam = "low",
ssp = "SSP5",
year_list = c(2010:2099))
SSP1 = SSP1 %>% mutate(ssp = "SSP1")
SSP2 = SSP2 %>% mutate(ssp = "SSP2")
SSP3 = SSP3 %>% mutate(ssp = "SSP3")
SSP4 = SSP4 %>% mutate(ssp = "SSP4")
SSP5 = SSP5 %>% mutate(ssp = "SSP5")
ssb = rbind(SSP1, SSP2, SSP3, SSP4, SSP5)
write.csv(ssb, '/project/cil/home_dirs/egrenier/ssps.csv')
source('/project/cil/home_dirs/egrenier/repos/agriculture/1_code/3_projections/1_visualize_projections/utils.R', echo=TRUE)
source('/project/cil/home_dirs/egrenier/repos/agriculture/1_code/3_projections/1_visualize_projections/utils.R', echo=TRUE)
pop_new = fread(glue("{input}/econ_clim-CCSM4-rcp45-SSP2-low.csv")) %>% filter(year == 2050) #%>% select(region, all_of(paste0(agegroup, "_share")))
pop_old = fread(glue("{input}/econ_clim-CCSM4-rcp45-SSP2-low.csv")) %>% filter(year == 2025) #%>% select(region, all_of(paste0(agegroup, "_share")))
#==============================================================================#
# Load in the required packages, installing them if necessary
library(tidyverse)
library(multidplyr)
library(glue)
library(sf)
library(scales)
library(rnaturalearth)
library(ncdf4)
library(reticulate)
library(data.table)
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/helper_functions/mapping_ineq.R')
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R')
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/analysis/utils/get_dscim_econ_vars_ineq.R')
input = '/project/cil/gcp/regional_scc/data/deltabeta/input/covariates'
output = "/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/output/maps"
DEFAULT_CRS = glue("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84",
" +datum=WGS84 +units=m +no_defs")
map.df = st_read('/project/cil/sacagawea_shares/gcp/regions/world_combo_201710_mockup/agglomerated-world-new-simp100.shp')
map.df = map.df %>%
st_transform(DEFAULT_CRS) %>%
filter(!(hierid %in% c("CA-", "USA.23.1273", "USA.14.642",
"USA.50.3082", "USA.50.3083", "USA.23.1275",
"USA.15.740", "USA.24.1355", "USA.33.1855",
"USA.36.2089", "USA.23.1272", "UGA.32.80.484",
"UGA.31.79.483.2760", "UGA.32.80.484.2761",
"TZA.13.59.1169", "TZA.5.26.564", "TZA.17.86.1759",
"ATA", "PER.8.71.705", "PER.7.67.677",
"ARM.7", "USA.23.1274", "TZA.8.37.779")))
year = 2025 #or 2025
ub = 50
title = glue("{agegroup} age group population share {year}")
colorbar_title = "Population share (%)"
agegroup = "oldest"
title = glue("{agegroup} age group population share {year}")
colorbar_title = "Population share (%)"
slug= "-alt"
map.df = st_read('/project/cil/sacagawea_shares/gcp/regions/world_combo_201710_mockup/agglomerated-world-new-simp100.shp')
map.df = map.df %>%
st_transform(DEFAULT_CRS) %>%
filter(!(hierid %in% c("CA-", "USA.23.1273", "USA.14.642",
"USA.50.3082", "USA.50.3083", "USA.23.1275",
"USA.15.740", "USA.24.1355", "USA.33.1855",
"USA.36.2089", "USA.23.1272", "UGA.32.80.484",
"UGA.31.79.483.2760", "UGA.32.80.484.2761",
"TZA.13.59.1169", "TZA.5.26.564", "TZA.17.86.1759",
"ATA", "PER.8.71.705", "PER.7.67.677",
"ARM.7", "USA.23.1274", "TZA.8.37.779")))
print(glue("Reading population data"))
pop_new = fread(glue("{input}/econ_clim-CCSM4-rcp45-SSP2-low.csv")) %>% filter(year == 2050) #%>% select(region, all_of(paste0(agegroup, "_share")))
pop_old = fread(glue("{input}/econ_clim-CCSM4-rcp45-SSP2-low.csv")) %>% filter(year == 2025) #%>% select(region, all_of(paste0(agegroup, "_share")))
View(pop_new)
pop_new = pop_new %>% select(region, young_share, older_share, oldest_share)
pop_new = pop_new %>% rename(young_share_2050 = young_share, older_share_2050=older_share, oldest_share_2050 = oldest_share)
pop_old = pop_old %>% select(region, young_share, older_share, oldest_share)
pop_old = pop_old %>% rename(young_share_2025 = young_share, older_share_2025=older_share, oldest_share_2025 = oldest_share)
pop = pop_new %>% left_join(pop_old)
View(pop)
pop = pop %>% mutate(iso = substr(region, 1, 3))
pop = pop %>%
group_by(iso) %>%
summarise(
across(starts_with("young_share"), ~ first(na.omit(.x))),
across(starts_with("older_share"), ~ first(na.omit(.x))),
across(starts_with("oldest_share"), ~ first(na.omit(.x)))
) %>%
ungroup()
pop_new = pop_new %>% mutate(iso = substr(region, 1, 3))
length(unique(pop_new$iso))
View(pop)
View(pop)
pop$diff_oldest = pop$oldest_share_2050 - pop$oldest_share_2025
pop$diff_older = pop$older_share_2050 - pop$older_share_2025
pop$diff_young = pop$young_share_2050 - pop$young_share_2025
View(pop_new)
View(pop)
df=  fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low-hot.csv")
df2 = fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low-hot.csv")
View(df)
df=  fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low.csv")
View(df2)
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/projection/1_mortality_db_script.R', echo=TRUE)
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/projection/1_mortality_db_script.R', echo=TRUE)
options(max.print=1000000)
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/projection/1_mortality_db_script.R', echo=TRUE)
df=  fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low.csv")
View(df)
df2 =  fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low-deltabeta_total.csv")
View(df2)
df2 =  fread("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready/mortality/combined-fulladapt-ir_level-rates-3_c-midc-SSP2-low-hot.csv")
source("~/repos/inequality/4_figures_and_tables/load_utils.R")
source("/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R")
View(get_tbar_income)
setwd("/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/projection")
getwd
getwd()
source(glue("/project/cil/home_dirs/egrenier/repos/post-projection-tools/response_function/yellow_purple_package.R"))
REPO = '/project/cil/home_dirs/egrenier/repos'
source(glue("/project/cil/home_dirs/egrenier/repos/post-projection-tools/response_function/yellow_purple_package.R"))
REPO = '/project/cil/home_dirs/egrenier/repos'
source(glue("/project/cil/home_dirs/egrenier/repos/post-projection-tools/response_function/yellow_purple_package.R"))
View(responses_wrapper_ag_edd)
packages <- c("glue", "tidyverse", "multidplyr", "data.table", "reticulate")
invisible(lapply(packages, function(pkg) {
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R')
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/analysis/utils/get_dscim_econ_vars_ineq.R')
# I/O doesn't change across specs
input ='/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready'
output = '/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/output/data_release'
define_ranking = function(df1, df2){
df1 = df1 %>% arrange(q50) %>% mutate(index_old = row_number()) %>% select(region, index_old)
df2 = df2 %>% arrange(q50) %>% mutate(index = row_number())
df2 = df2 %>% left_join(df1, by="region") %>%
mutate(delta = index_old - index) %>%
mutate(delta = if_else(delta > 0, paste0("+", as.character(delta)), as.character(delta))) %>%
mutate(delta = if_else(delta == 0, "--" , delta))
return(df2)
}
run_table = function(sector, category, scn, unit, gwl_bin, period, spatial, ranking){
message(glue('---- Running {sector} {category} {scn} impacts ({gwl_bin}, {period}) ----'))
message(glue('---- Units: {unit}'))
message(glue('---- Ranking: {ranking}'))
message(glue('---- Spatial: {spatial}'))
message(glue("Reading: {input}/{sector}/{category}-{scn}-{spatial}-{unit}-{gwl_bin}-{period}-SSP2-low.csv"))
impacts = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low.csv")) %>%
select(region, q50)
impacts_cold = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low-cold.csv")) %>%
select(region, q50)
continents = read_csv('/project/cil/gcp/regions/continents2.csv', show_col_types = FALSE) %>%
select(`alpha-3`, region, `sub-region`) %>%
rename(iso = `alpha-3`,
continent = region,
sub_region = `sub-region`) %>%
mutate(iso = ifelse(iso=='SXM', 'SMX', iso),
continent = ifelse(iso=='ATA', 'Antarctica', continent),
sub_region = ifelse(iso=='ATA', 'Antarctica', sub_region)) %>%
bind_rows(data.frame(iso = "KO-", continent = "Europe"),
data.frame(iso = "CA-", continent = "Asia")) %>%
mutate(continent = ifelse(continent == "Americas", sub_region, continent)) %>%
filter(continent != "Antarctica") %>%
select(iso, continent)
continents_list = unique(continents$continent)
continent_code = c(
"Asia" = "asia",
"Europe" = "eu",
"Africa" = "afr",
"Oceania" = "oce",
"Latin America and the Caribbean" = "lac",
"Antarctica" = "ant",
"Northern America" = "na"
)
if (ranking == 'city'){
cities = read.csv('/project/cil/gcp/regions/500k_cities.csv') %>% select(city, region = Region_ID)
cities = cities %>% mutate(iso = substr(region, 1, 3)) %>% distinct(region, .keep_all = TRUE)
# To get country names in the table
names = read_csv('/project/cil/gcp/regions/hierarchy.csv', skip=31, show_col_types = FALSE) %>% select(`region-key`, name) %>% rename(region=`region-key`)
names = names %>% filter(nchar(region) <= 3 & region != "") %>% rename(iso = region)
cities = cities %>% left_join(names) %>% mutate(city = glue("{city}, {name}"))
cities_ranked = cities %>% left_join(impacts)
cities_ranked_cold = cities %>% left_join(impacts_cold)
cities_ranked_cold = define_ranking(cities_ranked, cities_ranked_cold) %>% select(city, region, q50, delta)
# save out full ranking
message(glue('Saving: cities_ranked-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(cities_ranked_cold, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
# print top 25
txt = cities_ranked_cold %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
within_cont = cities %>% left_join(impacts) %>% left_join(continents)
within_cont_cold = cities %>% left_join(impacts_cold) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% select(city, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
} else if (ranking == 'ir'){
# arrange in descending order
ir_ranked_cold = define_ranking(impacts, impacts_cold)
names = read.csv('/project/cil/gcp/regions/hierarchy-flat.csv') %>% select(region.key, name) %>% rename(region=region.key)
ir_ranked_cold = ir_ranked_cold %>% left_join(names) %>% select(name, region, q50, delta)
# print top 25
txt = ir_ranked_cold %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
# save out full ranking
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(ir_ranked_cold, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
within_cont = impacts %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
within_cont_cold = impacts_cold %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% left_join(names) %>% select(name, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(name, region, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
}
}
# this will run all combos
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="rates",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="city")
continents = read_csv('/project/cil/gcp/regions/continents2.csv', show_col_types = FALSE)
View(continents)
packages <- c("glue", "tidyverse", "data.table", "reticulate")
invisible(lapply(packages, function(pkg) {
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R')
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/analysis/utils/get_dscim_econ_vars_ineq.R')
# I/O doesn't change across specs
input ='/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready'
output = '/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/output/data_release'
define_ranking = function(df1, df2){
df1 = df1 %>% arrange(q50) %>% mutate(index_old = row_number()) %>% select(region, index_old)
df2 = df2 %>% arrange(q50) %>% mutate(index = row_number())
df2 = df2 %>% left_join(df1, by="region") %>%
mutate(delta = index_old - index) %>%
mutate(delta = if_else(delta > 0, paste0("+", as.character(delta)), as.character(delta))) %>%
mutate(delta = if_else(delta == 0, "--" , delta))
return(df2)
}
run_table = function(sector, category, scn, unit, gwl_bin, period, spatial, ranking){
message(glue('---- Running {sector} {category} {scn} impacts ({gwl_bin}, {period}) ----'))
message(glue('---- Units: {unit}'))
message(glue('---- Ranking: {ranking}'))
message(glue('---- Spatial: {spatial}'))
message(glue("Reading: {input}/{sector}/{category}-{scn}-{spatial}-{unit}-{gwl_bin}-{period}-SSP2-low.csv"))
impacts = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low.csv")) %>%
select(region, q50)
impacts_cold = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low-cold.csv")) %>%
select(region, q50)
continents = read_csv('/project/cil/gcp/regions/continents2.csv', show_col_types = FALSE) %>%
select(`alpha-3`, region, `sub-region`) %>%
rename(iso = `alpha-3`,
continent = region,
sub_region = `sub-region`) %>%
mutate(iso = ifelse(iso=='SXM', 'SMX', iso),
continent = ifelse(iso=='ATA', 'Antarctica', continent),
sub_region = ifelse(iso=='ATA', 'Antarctica', sub_region)) %>%
bind_rows(data.frame(iso = "KO-", continent = "Europe"),
data.frame(iso = "CA-", continent = "Asia")) %>%
mutate(continent = ifelse(continent == "Americas", sub_region, continent)) %>%
filter(continent != "Antarctica") %>%
select(iso, continent)
continents_list = unique(continents$continent)
continent_code = c(
"Asia" = "asia",
"Europe" = "eu",
"Africa" = "afr",
"Oceania" = "oce",
"Latin America and the Caribbean" = "lac",
"Antarctica" = "ant",
"Northern America" = "na"
)
if (ranking == 'city'){
cities = read.csv('/project/cil/gcp/regions/500k_cities.csv') %>% select(city, region = Region_ID)
cities = cities %>% mutate(iso = substr(region, 1, 3)) %>% distinct(region, .keep_all = TRUE)
# To get country names in the table
names = read_csv('/project/cil/gcp/regions/hierarchy.csv', skip=31, show_col_types = FALSE) %>% select(`region-key`, name) %>% rename(region=`region-key`)
names = names %>% filter(nchar(region) <= 3 & region != "") %>% rename(iso = region)
cities = cities %>% left_join(names) %>% mutate(city = glue("{city}, {name}"))
cities_ranked = cities %>% left_join(impacts)
cities_ranked_cold = cities %>% left_join(impacts_cold)
cities_ranked_cold = define_ranking(cities_ranked, cities_ranked_cold) %>% select(city, region, q50, delta)
# save out full ranking
message(glue('Saving: cities_ranked-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(cities_ranked_cold, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
# print top 25
txt = cities_ranked_cold %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
within_cont = cities %>% left_join(impacts) %>% left_join(continents)
within_cont_cold = cities %>% left_join(impacts_cold) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% select(city, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
} else if (ranking == 'ir'){
# arrange in descending order
ir_ranked_cold = define_ranking(impacts, impacts_cold)
names = read.csv('/project/cil/gcp/regions/hierarchy-flat.csv') %>% select(region.key, name) %>% rename(region=region.key)
ir_ranked_cold = ir_ranked_cold %>% left_join(names) %>% select(name, region, q50, delta)
# print top 25
txt = ir_ranked_cold %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
# save out full ranking
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(ir_ranked_cold, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
within_cont = impacts %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
within_cont_cold = impacts_cold %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% left_join(names) %>% select(name, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(name, region, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
}
}
# this will run all combos
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="rates",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="city")
packages <- c("glue", "dplyr", "data.table", "reticulate")
invisible(lapply(packages, function(pkg) {
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))
packages <- c("glue", "dplyr", "data.table", "reticulate")
invisible(lapply(packages, function(pkg) {
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R')
source('/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/code/analysis/utils/get_dscim_econ_vars_ineq.R')
# I/O doesn't change across specs
input ='/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/data/analysis_ready'
output = '/project/cil/home_dirs/egrenier/cil-comms/adaptation_report/output/data_release'
define_ranking = function(df1, df2){
df1 = df1 %>% arrange(q50) %>% mutate(index_old = row_number()) %>% select(region, index_old)
df2 = df2 %>% arrange(q50) %>% mutate(index = row_number())
df2 = df2 %>% left_join(df1, by="region") %>%
mutate(delta = index_old - index) %>%
mutate(delta = if_else(delta > 0, paste0("+", as.character(delta)), as.character(delta))) %>%
mutate(delta = if_else(delta == 0, "--" , delta))
return(df2)
}
run_table = function(sector, category, scn, unit, gwl_bin, period, spatial, ranking){
message(glue('---- Running {sector} {category} {scn} impacts ({gwl_bin}, {period}) ----'))
message(glue('---- Units: {unit}'))
message(glue('---- Ranking: {ranking}'))
message(glue('---- Spatial: {spatial}'))
message(glue("Reading: {input}/{sector}/{category}-{scn}-{spatial}-{unit}-{gwl_bin}-{period}-SSP2-low.csv"))
impacts = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low.csv")) %>%
select(region, q50)
impacts_cold = read.csv(glue("{input}/{sector}/{category}-{scn}-ir_level-{unit}-{gwl_bin}-{period}-SSP2-low-cold.csv")) %>%
select(region, q50)
continents = read_csv('/project/cil/gcp/regions/continents2.csv', show_col_types = FALSE) %>%
select(`alpha-3`, region, `sub-region`) %>%
rename(iso = `alpha-3`,
continent = region,
sub_region = `sub-region`) %>%
mutate(iso = ifelse(iso=='SXM', 'SMX', iso),
continent = ifelse(iso=='ATA', 'Antarctica', continent),
sub_region = ifelse(iso=='ATA', 'Antarctica', sub_region)) %>%
bind_rows(data.frame(iso = "KO-", continent = "Europe"),
data.frame(iso = "CA-", continent = "Asia")) %>%
mutate(continent = ifelse(continent == "Americas", sub_region, continent)) %>%
filter(continent != "Antarctica") %>%
select(iso, continent)
continents_list = unique(continents$continent)
continent_code = c(
"Asia" = "asia",
"Europe" = "eu",
"Africa" = "afr",
"Oceania" = "oce",
"Latin America and the Caribbean" = "lac",
"Antarctica" = "ant",
"Northern America" = "na"
)
if (ranking == 'city'){
cities = read.csv('/project/cil/gcp/regions/500k_cities.csv') %>% select(city, region = Region_ID)
cities = cities %>% mutate(iso = substr(region, 1, 3)) %>% distinct(region, .keep_all = TRUE)
# To get country names in the table
names = read_csv('/project/cil/gcp/regions/hierarchy.csv', skip=31, show_col_types = FALSE) %>% select(`region-key`, name) %>% rename(region=`region-key`)
names = names %>% filter(nchar(region) <= 3 & region != "") %>% rename(iso = region)
cities = cities %>% left_join(names) %>% mutate(city = glue("{city}, {name}"))
cities_ranked = cities %>% left_join(impacts)
cities_ranked_cold = cities %>% left_join(impacts_cold)
cities_ranked_cold = define_ranking(cities_ranked, cities_ranked_cold) %>% select(city, region, q50, delta)
# save out full ranking
message(glue('Saving: cities_ranked-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(cities_ranked_cold, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
# print top 25
txt = cities_ranked_cold %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
within_cont = cities %>% left_join(impacts) %>% left_join(continents)
within_cont_cold = cities %>% left_join(impacts_cold) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% select(city, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(city, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/cities_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
} else if (ranking == 'ir'){
# arrange in descending order
ir_ranked_cold = define_ranking(impacts, impacts_cold)
names = read.csv('/project/cil/gcp/regions/hierarchy-flat.csv') %>% select(region.key, name) %>% rename(region=region.key)
ir_ranked_cold = ir_ranked_cold %>% left_join(names) %>% select(name, region, q50, delta)
# print top 25
txt = ir_ranked_cold %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
# save out full ranking
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv \n in {output}/{sector}'))
write.csv(ir_ranked_cold, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold.csv'), row.names=F)
within_cont = impacts %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
within_cont_cold = impacts_cold %>% mutate(iso = substr(region,1,3)) %>% left_join(continents)
for (c in continents_list){
within_cont_sub = within_cont %>% filter(continent == c)
within_cont_cold_sub = within_cont_cold %>% filter(continent == c)
ranked = define_ranking(within_cont_sub, within_cont_cold_sub) %>% left_join(names) %>% select(name, region, q50, delta)
print(glue("\n City ranking for continent: {c}"))
txt = ranked %>% select(name, region, q50, delta) %>% slice_head(n = 25) %>% mutate(q50 = sprintf("%.1f", q50)) %>% format_tsv()
cat(txt)
cont = continent_code[c] # get continent code
message(glue('Saving: impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv \n in {output}/{sector}'))
write.csv(ranked, glue('{output}/{sector}/impact_regions_ranked-{sector}-{category}-{scn}-{unit}-{gwl_bin}-{period}-cold-{cont}.csv'), row.names=F)
}
}
}
# this will run all combos
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="rates",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="city")
packages <- c("glue", "dplyr", "readr", "data.table", "reticulate")
invisible(lapply(packages, function(pkg) {
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))
source('/project/cil/home_dirs/egrenier/repos/inequality/4_figures_and_tables/load_utils.R')
rm(packages)
# this will run all combos
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="rates",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="city")
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="levels",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="city")
run_table(sector="mortality",
category="combined",
scn="fulladapt",
unit="rates",
gwl_bin="3_c",
period="midc",
spatial="ir_level",
ranking="ir")
